{% extends "base.html" %}

{% block title %}Sortear Lojas - Admin{% endblock %}

{% block content %}
<style>
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

.sortear-container {
    padding: 20px 0;
    min-height: 100vh;
}

.sortear-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.pote-container {
    background: rgba(255, 255, 255, 0.9);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border: 2px solid transparent;
    transition: all 0.3s ease;
}

.pote-big {
    border-color: #8e44ad;
    background: linear-gradient(145deg, rgba(142, 68, 173, 0.1), rgba(155, 89, 182, 0.05));
}

.pote-ultra {
    border-color: #00a651;
    background: linear-gradient(145deg, rgba(0, 166, 81, 0.1), rgba(39, 174, 96, 0.05));
}

.loja-item {
    display: inline-block;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 4px 8px;
    margin: 2px;
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.loja-disponivel {
    background: linear-gradient(45deg, #d4edda, #c3e6cb);
    border-color: #28a745;
    color: #155724;
}

.loja-sorteada {
    background: linear-gradient(45deg, #f8d7da, #f5c6cb);
    border-color: #dc3545;
    color: #721c24;
    opacity: 0.7;
}

.btn-chacoalhar {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 30px;
    font-size: 1.1rem;
    font-weight: bold;
    box-shadow: 0 8px 16px rgba(238, 90, 36, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-chacoalhar:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(238, 90, 36, 0.4);
    background: linear-gradient(45deg, #ee5a24, #ff6b6b);
}

.btn-sortear-final {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 15px 30px;
    font-size: 1.2rem;
    font-weight: bold;
    box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 10px;
}

.btn-sortear-final:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
}

.btn-sortear-final:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-chacoalhar:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.6;
}

.tremor {
    animation: shake 0.5s;
    animation-iteration-count: infinite;
}

@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.resultado-existente {
    background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 20px rgba(253, 203, 110, 0.3);
}

.ganhador-nome {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 15px 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.ganhador-big {
    color: #8e44ad;
}

.ganhador-ultra {
    color: #00a651;
}

.btn-discreto {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(108, 117, 125, 0.8);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 10px 20px;
    font-size: 0.9rem;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.btn-discreto:hover {
    background: rgba(108, 117, 125, 1);
    transform: scale(1.1);
}

.festival-header {
    text-align: center;
    color: white;
    margin-bottom: 20px;
}

.festival-header h1 {
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 10px;
}

.festival-header .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
}

.contador-lojas {
    text-align: center;
    color: #495057;
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 10px;
}

.embaralhar {
    animation: spin 0.5s ease-in-out;
}

@keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}

.pote-title {
    font-size: 1.2rem;
    margin-bottom: 10px;
}

.secao-lojas h6 {
    font-size: 0.8rem;
    margin-bottom: 8px;
}

.botoes-container {
    text-align: center;
    margin-top: 15px;
}

.compacto {
    max-height: 400px;
    overflow-y: auto;
}
</style>

<div class="sortear-container">
    <div class="container">
        <!-- Header do Festival -->
        <div class="festival-header">
            <h1>üé≤ SORTEIO SEMANAL</h1>
            <div class="subtitle">Festival Na Praia 2025 ‚Ä¢ BigBox & UltraBox</div>
        </div>

        <!-- Layout Compacto: Data + Potes + Bot√µes na mesma tela -->
        <div class="row">
            <!-- Coluna da Esquerda: Data e Bot√µes -->
            <div class="col-lg-4">
                <div class="sortear-card mb-3">
                    <div class="card-body p-3">
                        <form id="sorteioForm">
                            {{ form.hidden_tag() }}
                            <div class="text-center mb-3">
                                <h5>üìÖ Semana do Sorteio</h5>
                            </div>
                            
                            <div class="mb-3">
                                {{ form.semana_inicio(class="form-control text-center", id="semanaInicio") }}
                                <div class="form-text text-center">
                                    Ter√ßa-feira da semana
                                </div>
                            </div>
                            
                            <!-- Bot√µes sempre na mesma posi√ß√£o -->
                            <div class="botoes-container">
                                <button type="button" class="btn btn-chacoalhar" id="btnChacoalhar" disabled>
                                    üé≤ Chacoalhar Potes
                                </button>
                                
                                <button type="button" class="btn btn-sortear-final" id="btnSortearFinal" disabled>
                                    üéØ Realizar Sorteio
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Status do Sorteio -->
                <div id="statusSorteio" class="alert alert-info text-center">
                    <small id="statusTexto">Selecione uma data para come√ßar</small>
                </div>
            </div>

            <!-- Coluna da Direita: Potes das Lojas -->
            <div class="col-lg-8">
                <!-- Resultado de Sorteio Existente ser√° inserido aqui via JS -->
                <div id="resultadoExistente" style="display: none;"></div>

                <!-- Potes de Lojas Compactos -->
                <div id="potesContainer">
                    <!-- Pote BIG -->
                    <div class="pote-container pote-big compacto">
                        <h4 class="text-center pote-title">
                            üè¢ POTE BIG
                            <div class="contador-lojas">
                                <span id="contadorBig">{{ lojas_big|length }}</span> dispon√≠veis
                            </div>
                        </h4>
                        
                        <div class="secao-lojas mb-2">
                            <h6>üü¢ Dispon√≠veis:</h6>
                            <div id="lojasBigDisponiveis">
                                {% for loja in lojas_big %}
                                <span class="loja-item loja-disponivel" data-id="{{ loja.id }}">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if lojas_big_sorteadas %}
                        <div class="secao-lojas">
                            <h6>‚≠ï J√° Sorteadas:</h6>
                            <div>
                                {% for loja in lojas_big_sorteadas %}
                                <span class="loja-item loja-sorteada">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Pote ULTRA -->
                    <div class="pote-container pote-ultra compacto">
                        <h4 class="text-center pote-title">
                            üè¨ POTE ULTRA
                            <div class="contador-lojas">
                                <span id="contadorUltra">{{ lojas_ultra|length }}</span> dispon√≠veis
                            </div>
                        </h4>
                        
                        <div class="secao-lojas mb-2">
                            <h6>üü¢ Dispon√≠veis:</h6>
                            <div id="lojasUltraDisponiveis">
                                {% for loja in lojas_ultra %}
                                <span class="loja-item loja-disponivel" data-id="{{ loja.id }}">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if lojas_ultra_sorteadas %}
                        <div class="secao-lojas">
                            <h6>‚≠ï J√° Sorteadas:</h6>
                            <div>
                                {% for loja in lojas_ultra_sorteadas %}
                                <span class="loja-item loja-sorteada">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√£o Discreto para Dashboard -->
<a href="{{ url_for('admin.dashboard') }}" class="btn btn-discreto">
    ‚Üê Dashboard
</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('sorteioForm');
    const btnChacoalhar = document.getElementById('btnChacoalhar');
    const btnSortearFinal = document.getElementById('btnSortearFinal');
    const potesContainer = document.getElementById('potesContainer');
    const resultadoExistente = document.getElementById('resultadoExistente');
    const semanaInicio = document.getElementById('semanaInicio');
    const statusSorteio = document.getElementById('statusSorteio');
    const statusTexto = document.getElementById('statusTexto');
    
    // Dados das lojas (do backend)
    const lojasBig = JSON.parse('{{ lojas_big | tojson | safe }}');
    const lojasUltra = JSON.parse('{{ lojas_ultra | tojson | safe }}');
    
    let poteChacoalhado = false;
    let seedRandom = Date.now();
    let sorteioJaRealizado = false;
    
    // Verifica sorteio existente quando data muda
    semanaInicio.addEventListener('change', function() {
        if (this.value) {
            verificarSorteioExistente(this.value);
        } else {
            resetarInterface();
        }
    });
    
    // Fun√ß√£o para verificar se j√° existe sorteio
    function verificarSorteioExistente(data) {
        statusTexto.textContent = 'Verificando sorteio existente...';
        statusSorteio.className = 'alert alert-info text-center';
        
        fetch('/admin/sortear/verificar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ semana_inicio: data })
        })
        .then(response => response.json())
        .then(result => {
            if (result.existe) {
                // Sorteio j√° existe - mostra resultado e desabilita bot√µes
                mostrarSorteioExistente(result.data);
                sorteioJaRealizado = true;
            } else {
                // Liberado para novo sorteio
                liberarParaNovoSorteio();
            }
        })
        .catch(error => {
            console.error('Erro ao verificar sorteio:', error);
            statusTexto.textContent = 'Erro ao verificar sorteio. Tente novamente.';
            statusSorteio.className = 'alert alert-danger text-center';
        });
    }
    
    // Libera interface para novo sorteio
    function liberarParaNovoSorteio() {
        sorteioJaRealizado = false;
        potesContainer.style.display = 'block';
        resultadoExistente.style.display = 'none';
        
        // Verifica se h√° lojas suficientes
        if (lojasBig.length === 0 || lojasUltra.length === 0) {
            statusTexto.textContent = '‚ö†Ô∏è N√£o h√° lojas suficientes para sortear!';
            statusSorteio.className = 'alert alert-warning text-center';
            btnChacoalhar.disabled = true;
            btnSortearFinal.disabled = true;
        } else {
            btnChacoalhar.disabled = false;
            statusTexto.textContent = 'Pronto! Chacoalhe os potes para come√ßar';
            statusSorteio.className = 'alert alert-success text-center';
        }
    }
    
    // Mostra sorteio j√° existente
    function mostrarSorteioExistente(dados) {
        potesContainer.style.display = 'none';
        resultadoExistente.style.display = 'block';
        
        resultadoExistente.innerHTML = `
            <div class="resultado-existente">
                <h4>‚úÖ Sorteio J√° Realizado</h4>
                <div class="row">
                    <div class="col-md-6">
                        <h5>üè¢ Loja BIG</h5>
                        <div class="ganhador-nome ganhador-big">
                            ${dados.loja_big.nome}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>üè¨ Loja ULTRA</h5>
                        <div class="ganhador-nome ganhador-ultra">
                            ${dados.loja_ultra.nome}
                        </div>
                    </div>
                </div>
                <p class="mt-3">
                    <small>Sorteio realizado em: ${dados.data_sorteio}</small>
                </p>
            </div>
        `;
        
        statusTexto.innerHTML = `<strong>‚ö†Ô∏è Sorteio j√° realizado para esta semana!</strong><br/>
            BIG: <strong>${dados.loja_big.nome}</strong> | ULTRA: <strong>${dados.loja_ultra.nome}</strong>`;
        statusSorteio.className = 'alert alert-warning text-center';
        
        // Desabilita todos os bot√µes
        btnChacoalhar.disabled = true;
        btnSortearFinal.disabled = true;
        btnChacoalhar.textContent = '‚ùå J√Å SORTEADO';
        btnSortearFinal.textContent = '‚ùå J√Å REALIZADO';
    }
    
    // Fun√ß√£o chacoalhar
    btnChacoalhar.addEventListener('click', function() {
        if (sorteioJaRealizado) {
            alert('‚ö†Ô∏è Sorteio j√° foi realizado para esta semana!');
            return;
        }
        
        if (lojasBig.length === 0 || lojasUltra.length === 0) {
            alert('‚ö†Ô∏è N√£o h√° lojas suficientes para sortear!');
            return;
        }
        
        // Atualiza seed com hor√°rio atual
        seedRandom = Date.now();
        
        // Efeito visual de tremor
        potesContainer.classList.add('tremor');
        btnChacoalhar.disabled = true;
        btnChacoalhar.innerHTML = 'üå™Ô∏è CHACOALHANDO...';
        
        statusTexto.textContent = 'Chacoalhando os potes...';
        statusSorteio.className = 'alert alert-info text-center';
        
        // Embaralha as lojas visualmente
        embaralharLojas();
        
        setTimeout(() => {
            potesContainer.classList.remove('tremor');
            btnChacoalhar.disabled = false;
            btnChacoalhar.innerHTML = '‚úÖ POTES CHACOALHADOS';
            btnChacoalhar.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            
            // Habilita bot√£o de sorteio
            btnSortearFinal.disabled = false;
            poteChacoalhado = true;
            
            statusTexto.textContent = 'Potes chacoalhados! Clique em "Realizar Sorteio"';
            statusSorteio.className = 'alert alert-primary text-center';
        }, 2000);
    });
    
    // Fun√ß√£o para embaralhar lojas visualmente
    function embaralharLojas() {
        const intervalos = [];
        
        // Embaralha BIG
        const containerBig = document.getElementById('lojasBigDisponiveis');
        intervalos.push(setInterval(() => {
            embaralharElementos(containerBig);
        }, 100));
        
        // Embaralha ULTRA  
        const containerUltra = document.getElementById('lojasUltraDisponiveis');
        intervalos.push(setInterval(() => {
            embaralharElementos(containerUltra);
        }, 100));
        
        // Para o embaralhamento ap√≥s 1.5s
        setTimeout(() => {
            intervalos.forEach(interval => clearInterval(interval));
        }, 1500);
    }
    
    // Embaralha elementos DOM
    function embaralharElementos(container) {
        const elementos = Array.from(container.children);
        elementos.forEach(el => el.classList.add('embaralhar'));
        
        // Reordena elementos
        for (let i = elementos.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            container.appendChild(elementos[j]);
        }
        
        setTimeout(() => {
            elementos.forEach(el => el.classList.remove('embaralhar'));
        }, 300);
    }
    
    // Sortear final
    btnSortearFinal.addEventListener('click', function() {
        if (sorteioJaRealizado) {
            alert('‚ö†Ô∏è Sorteio j√° foi realizado para esta semana!');
            return;
        }
        
        if (!poteChacoalhado) {
            alert('‚ö†Ô∏è Voc√™ precisa chacoalhar os potes primeiro!');
            return;
        }
        
        // Usa a seed gerada no chacoalhar para determinismo
        Math.seedrandom(seedRandom);
        
        statusTexto.textContent = 'Iniciando sorteio...';
        statusSorteio.className = 'alert alert-warning text-center';
        
        // Chama a fun√ß√£o corretamente
        window.sorteioAnimado.iniciarSorteioLojas(lojasBig, lojasUltra);
    });
    
    // Resetar interface
    function resetarInterface() {
        poteChacoalhado = false;
        sorteioJaRealizado = false;
        btnChacoalhar.innerHTML = 'üé≤ Chacoalhar Potes';
        btnChacoalhar.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
        btnChacoalhar.disabled = true;
        btnSortearFinal.disabled = true;
        btnSortearFinal.textContent = 'üéØ Realizar Sorteio';
        potesContainer.style.display = 'block';
        resultadoExistente.style.display = 'none';
        statusTexto.textContent = 'Selecione uma data para come√ßar';
        statusSorteio.className = 'alert alert-info text-center';
    }
    
    // Sobrescreve fun√ß√£o AJAX do sorteio
    window.sorteioAnimado.submitarFormularioAjax = function(resultados) {
        const lojaBig = resultados.find(r => r.tipo === 'Loja BIG');
        const lojaUltra = resultados.find(r => r.tipo === 'Loja ULTRA');
        
        if (!lojaBig || !lojaUltra) {
            window.sorteioAnimado.exibirErro('Erro nos resultados do sorteio');
            return;
        }
        
        const dados = {
            semana_inicio: semanaInicio.value,
            loja_big_id: lojaBig.vencedor.id,
            loja_ultra_id: lojaUltra.vencedor.id
        };
        
        fetch('/admin/sortear/ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Personaliza mensagem de sucesso
                const mensagemParabens = `
                    üéâ PARAB√âNS AOS GANHADORES! üéâ<br/>
                    <strong>${lojaBig.vencedor.nome}</strong> (BIG) e <strong>${lojaUltra.vencedor.nome}</strong> (ULTRA)<br/>
                    Voc√™s foram sorteados para a semana de ${data.data.semana}!
                `;
                window.sorteioAnimado.exibirSucesso(mensagemParabens);
            } else {
                window.sorteioAnimado.exibirErro(data.message);
            }
        })
        .catch(error => {
            console.error('Erro AJAX:', error);
            window.sorteioAnimado.exibirErro('Erro de comunica√ß√£o com o servidor');
        });
    };
});

// Adiciona biblioteca para seed random
!function(a,b){function c(c,d,e){var f=[];d=1==d?{entropy:!0}:d||{};var g=h(i(d.entropy?[c,j(a)]:null==c?k():c,3),f),l=new m(f),n=function(){for(var a=l.g(o),b=p,c=0;q>a;)a=(a+c)*r,b*=r,c=l.g(1);for(;a>=s;)a/=2,b/=2,c>>>=1;return(a+c)/b};return n.int32=function(){return 0|l.g(4)},n.quick=function(){return l.g(4)/4294967296},n.double=n,h(j(l.S),a),(d.pass||e||function(a,c,d,e){return e&&(e.S&&n(e,l),a.state=function(){return n(l,{})}),d?(b[t]=a,c):a})(n,g,"global"in d?d.global:this==b,d.state)}function d(a){return typeof a==="string"?a:String(a)}function e(a,b){return typeof a==="number"?a:parseInt(b,10)}function f(a,b){return a>b?a:b}function g(a,b){return a<b?a:b}function h(a,b){var c,d=a.length,e=0,f=0;for(c=0;d>c;c++)e=19*e+a.charCodeAt(c),f=e&((1<<6)-1);return(b[f]=(b[f]||0)+1,String.fromCharCode(f))}function i(a,b){var c=a+"",d,e=0;for(b=0;b<c.length;)d=.02519603282416938*c.charCodeAt(b++),d-=~~d,e+=d*d*d*7*5e6;return e}function j(a){for(var b,c=a.length,d=this,e=0,f=d.i=d.j=0,g=d.S=[];c>e;)g[e]=e++;for(e=0;c>e;e++)g[e]=g[f=w&f+g[e]+g[(d.i=w&d.i+1)]],g[f]=g[d.i];(d.i=d.j=0)}function k(){try{var b;return u&&(b=u.randomBytes)?b=b(r):(b=new Uint8Array(r),(v.crypto||v.msCrypto).getRandomValues(b)),j(b)}catch(c){var d=v.navigator,e=d&&d.plugins;return j([+new Date,v,e,v.screen,j(a)])}}function l(a){try{return u.createHash("sha256").update(a).digest()}catch(b){return[a]}}function m(a){j(this,a)}function n(a,b){return b.i=a.i,b.j=a.j,b.S=a.S.slice(),b}var o=6,p=52,q=1,r=4,s=Math.pow(2,53),t="random",u=c.crypto,v=c;if("object"==typeof module&&module.exports){module.exports=c;try{u=require("crypto")}catch(w){}}else"function"==typeof define&&define.amd?define(function(){return c}):v["seed"+t]=c;var x=Math.pow(r,o),y=Math.pow(2,p),z=2*y,A=r-1,w=4294967295;if(l(b[t])!=b[t]&&l(Math.random())!=Math.random()){b[t]=c}Math.seedrandom=c}([],"",Math);
</script>
{% endblock %} 