{% extends "base.html" %}

{% block title %}Sortear Lojas - Admin{% endblock %}

{% block content %}
<style>
body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

.sortear-container {
    padding: 15px 0;
    min-height: 100vh;
}

.sortear-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.pote-container {
    background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9));
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
    box-shadow: 
        0 8px 16px rgba(0, 0, 0, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    border: 2px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.pote-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, currentColor, transparent);
    opacity: 0.6;
}

.pote-big {
    border-color: #8e44ad;
    color: #8e44ad;
}

.pote-big::before {
    background: linear-gradient(90deg, transparent, #8e44ad, transparent);
}

.pote-ultra {
    border-color: #00a651;
    color: #00a651;
}

.pote-ultra::before {
    background: linear-gradient(90deg, transparent, #00a651, transparent);
}

.pote-title {
    font-size: 1rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.contador-lojas {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    padding: 4px 10px;
    margin: 5px auto;
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 600;
    color: #495057;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.secao-lojas {
    margin-bottom: 10px;
}

.secao-titulo {
    font-size: 0.7rem;
    font-weight: 600;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.loja-item {
    display: inline-block;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 3px 8px;
    margin: 2px;
    font-size: 0.65rem;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: default;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    line-height: 1.2;
}

.loja-disponivel {
    background: linear-gradient(145deg, #d4edda, #c3e6cb);
    border-color: #28a745;
    color: #155724;
}

.loja-disponivel:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
}

.loja-sorteada {
    background: linear-gradient(145deg, #f8d7da, #f5c6cb);
    border-color: #dc3545;
    color: #721c24;
    opacity: 0.8;
    position: relative;
}

.loja-sorteada::after {
    content: 'üèÜ';
    position: absolute;
    top: -3px;
    right: -3px;
    font-size: 0.6rem;
}

.btn-chacoalhar {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 0.9rem;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(238, 90, 36, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    width: 100%;
    margin-bottom: 8px;
}

.btn-chacoalhar:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(238, 90, 36, 0.4);
    background: linear-gradient(45deg, #ee5a24, #ff6b6b);
}

.btn-sortear-final {
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    width: 100%;
}

.btn-sortear-final:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
}

.btn-sortear-final:disabled, .btn-chacoalhar:disabled {
    background: linear-gradient(45deg, #6c757d, #5a6268);
    cursor: not-allowed;
    opacity: 0.6;
    transform: none !important;
    box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
}

.tremor {
    animation: shake 0.5s;
    animation-iteration-count: infinite;
}

@keyframes shake {
    0% { transform: translate(1px, 1px) rotate(0deg); }
    10% { transform: translate(-1px, -2px) rotate(-1deg); }
    20% { transform: translate(-3px, 0px) rotate(1deg); }
    30% { transform: translate(3px, 2px) rotate(0deg); }
    40% { transform: translate(1px, -1px) rotate(1deg); }
    50% { transform: translate(-1px, 2px) rotate(-1deg); }
    60% { transform: translate(-3px, 1px) rotate(0deg); }
    70% { transform: translate(3px, 1px) rotate(-1deg); }
    80% { transform: translate(-1px, -1px) rotate(1deg); }
    90% { transform: translate(1px, 2px) rotate(0deg); }
    100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.resultado-existente {
    background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
    border-radius: 15px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 8px 16px rgba(253, 203, 110, 0.3);
}

.ganhador-nome {
    font-size: 1.8rem;
    font-weight: bold;
    margin: 10px 0;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

.ganhador-big {
    color: #8e44ad;
}

.ganhador-ultra {
    color: #00a651;
}

.btn-discreto {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(108, 117, 125, 0.8);
    color: white;
    border: none;
    border-radius: 25px;
    padding: 8px 16px;
    font-size: 0.8rem;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.btn-discreto:hover {
    background: rgba(108, 117, 125, 1);
    transform: scale(1.1);
}

.festival-header {
    text-align: center;
    color: white;
    margin-bottom: 15px;
}

.festival-header h1 {
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    margin-bottom: 8px;
}

.festival-header .subtitle {
    font-size: 1rem;
    opacity: 0.9;
}

.embaralhar {
    animation: spin 0.5s ease-in-out;
}

@keyframes spin {
    0% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
    100% { transform: rotate(360deg) scale(1); }
}

.botoes-container {
    text-align: center;
    margin-top: 10px;
}

.compacto {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 8px;
}

.compacto::-webkit-scrollbar {
    width: 4px;
}

.compacto::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
}

.compacto::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 2px;
}

.status-icon {
    font-size: 1rem;
    margin-right: 3px;
}

.alert {
    padding: 8px 12px;
    margin-bottom: 10px;
    border-radius: 8px;
}

.alert small {
    font-size: 0.8rem;
}
</style>

<div class="sortear-container">
    <div class="container-fluid">
        <!-- Header do Festival -->
        <div class="festival-header">
            <h1>üé≤ SORTEIO SEMANAL</h1>
            <div class="subtitle">Festival Na Praia 2025 ‚Ä¢ BigBox & UltraBox</div>
        </div>

        <!-- Layout Compacto: Data + Potes + Bot√µes na mesma tela -->
        <div class="row">
            <!-- Coluna da Esquerda: Data e Bot√µes -->
            <div class="col-lg-3">
                <div class="sortear-card mb-2">
                    <div class="card-body p-3">
                        <form id="sorteioForm">
                            {{ form.hidden_tag() }}
                            <div class="text-center mb-2">
                                <h6>üìÖ Semana do Sorteio</h6>
                            </div>
                            
                            <div class="mb-2">
                                {{ form.semana_inicio(class="form-control form-control-sm text-center", id="semanaInicio") }}
                                <div class="form-text text-center small">
                                    Ter√ßa-feira da semana
                                </div>
                            </div>
                            
                            <!-- Bot√µes sempre na mesma posi√ß√£o -->
                            <div class="botoes-container">
                                <button type="button" class="btn btn-chacoalhar" id="btnChacoalhar" disabled>
                                    üé≤ Chacoalhar Potes
                                </button>
                                
                                <button type="button" class="btn btn-sortear-final" id="btnSortearFinal" disabled>
                                    üéØ Realizar Sorteio
                                </button>
                                
                                <!-- Bot√£o de Teste de Emerg√™ncia (aparece apenas em caso de problemas) -->
                                <button type="button" class="btn btn-outline-danger btn-sm mt-2" id="btnTesteEmergencia" style="display: none; width: 100%; font-size: 0.7rem;">
                                    üÜò Teste de Emerg√™ncia
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Status do Sorteio -->
                <div id="statusSorteio" class="alert alert-info text-center">
                    <small id="statusTexto">Inicializando sistema...</small>
                </div>
            </div>

            <!-- Coluna da Direita: Potes das Lojas -->
            <div class="col-lg-9">
                <!-- Resultado de Sorteio Existente ser√° inserido aqui via JS -->
                <div id="resultadoExistente" style="display: none;"></div>

                <!-- Potes de Lojas Compactos -->
                <div id="potesContainer">
                    <!-- Pote BIG -->
                    <div class="pote-container pote-big compacto">
                        <div class="pote-title">
                            üè¢ POTE BIG
                            <div class="contador-lojas">
                                <span id="contadorBig">{{ lojas_big|length }}</span> dispon√≠veis
                            </div>
                        </div>
                        
                        <div class="secao-lojas">
                            <div class="secao-titulo">
                                <span class="status-icon">üü¢</span>Dispon√≠veis
                            </div>
                            <div id="lojasBigDisponiveis">
                                {% for loja in lojas_big %}
                                <span class="loja-item loja-disponivel" data-id="{{ loja.id }}">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if lojas_big_sorteadas %}
                        <div class="secao-lojas">
                            <div class="secao-titulo">
                                <span class="status-icon">üèÜ</span>J√° Sorteadas
                            </div>
                            <div>
                                {% for loja in lojas_big_sorteadas %}
                                <span class="loja-item loja-sorteada">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Pote ULTRA -->
                    <div class="pote-container pote-ultra compacto">
                        <div class="pote-title">
                            üè¨ POTE ULTRA
                            <div class="contador-lojas">
                                <span id="contadorUltra">{{ lojas_ultra|length }}</span> dispon√≠veis
                            </div>
                        </div>
                        
                        <div class="secao-lojas">
                            <div class="secao-titulo">
                                <span class="status-icon">üü¢</span>Dispon√≠veis
                            </div>
                            <div id="lojasUltraDisponiveis">
                                {% for loja in lojas_ultra %}
                                <span class="loja-item loja-disponivel" data-id="{{ loja.id }}">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        {% if lojas_ultra_sorteadas %}
                        <div class="secao-lojas">
                            <div class="secao-titulo">
                                <span class="status-icon">üèÜ</span>J√° Sorteadas
                            </div>
                            <div>
                                {% for loja in lojas_ultra_sorteadas %}
                                <span class="loja-item loja-sorteada">
                                    {{ loja.nome }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√£o Discreto para Dashboard -->
<a href="{{ url_for('admin.dashboard') }}" class="btn btn-discreto">
    ‚Üê Dashboard
</a>

<script>
// ==========================================
//         SISTEMA DE SORTEIO V1.1
//    DEBUG COMPLETO E CORRE√á√ïES CR√çTICAS
// ==========================================

// Aguarda carregamento completo do DOM e do script.js
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ DOM carregado, aguardando script.js...');
    
    // Aguarda mais tempo para garantir que script.js carregou
    setTimeout(function() {
        initializeSorteioPaget();
    }, 1500); // Aumentado para 1.5s
});

function initializeSorteioPaget() {
    console.log('üöÄ === INICIALIZANDO SISTEMA DE SORTEIO ===');
    
    // ===== SE√á√ÉO 1: VERIFICA√á√ÉO DE ELEMENTOS =====
    const form = document.getElementById('sorteioForm');
    const btnChacoalhar = document.getElementById('btnChacoalhar');
    const btnSortearFinal = document.getElementById('btnSortearFinal');
    const btnTesteEmergencia = document.getElementById('btnTesteEmergencia');
    const potesContainer = document.getElementById('potesContainer');
    const resultadoExistente = document.getElementById('resultadoExistente');
    const semanaInicio = document.getElementById('semanaInicio');
    const statusSorteio = document.getElementById('statusSorteio');
    const statusTexto = document.getElementById('statusTexto');
    
    console.log('üîç Verificando elementos DOM:');
    console.log('  - Form:', !!form);
    console.log('  - BtnChacoalhar:', !!btnChacoalhar);
    console.log('  - BtnSortearFinal:', !!btnSortearFinal);
    console.log('  - BtnTesteEmergencia:', !!btnTesteEmergencia);
    console.log('  - PotesContainer:', !!potesContainer);
    console.log('  - SemanaInicio:', !!semanaInicio);
    console.log('  - StatusSorteio:', !!statusSorteio);
    console.log('  - StatusTexto:', !!statusTexto);
    
    // Verifica se elementos cr√≠ticos existem
    if (!form || !btnChacoalhar || !btnSortearFinal) {
        console.error('‚ùå ERRO CR√çTICO: Elementos n√£o encontrados!');
        console.error('  - form:', form);
        console.error('  - btnChacoalhar:', btnChacoalhar);
        console.error('  - btnSortearFinal:', btnSortearFinal);
        return;
    }
    
    // ===== SE√á√ÉO 2: VERIFICA√á√ÉO DO SORTEIOANIMADO =====
    console.log('üîç Verificando SorteioAnimado:');
    console.log('  - window.sorteioAnimado:', !!window.sorteioAnimado);
    console.log('  - Tipo:', typeof window.sorteioAnimado);
    
    if (!window.sorteioAnimado) {
        console.error('‚ùå ERRO CR√çTICO: SorteioAnimado n√£o encontrado!');
        
        // Aguarda mais tempo e tenta novamente
        console.log('‚è≥ Tentando aguardar mais tempo...');
        setTimeout(() => {
            console.log('üîÑ Segunda tentativa de verifica√ß√£o...');
            if (window.sorteioAnimado) {
                console.log('‚úÖ SorteioAnimado encontrado na segunda tentativa!');
                initializeSorteioPaget();
                return;
            } else {
                console.error('‚ùå SorteioAnimado ainda n√£o encontrado ap√≥s segunda tentativa');
                statusTexto.textContent = 'ERRO: Sistema n√£o carregado. Recarregue a p√°gina.';
                statusSorteio.className = 'alert alert-danger text-center';
            }
        }, 2000);
        return;
    }
    
    console.log('‚úÖ SorteioAnimado encontrado!');
    
    // ===== SE√á√ÉO 3: DADOS DAS LOJAS =====
    const lojasBig = JSON.parse('{{ lojas_big | tojson | safe }}');
    const lojasUltra = JSON.parse('{{ lojas_ultra | tojson | safe }}');
    
    console.log('üìä Dados das lojas:');
    console.log('  - Lojas BIG:', lojasBig.length, lojasBig);
    console.log('  - Lojas ULTRA:', lojasUltra.length, lojasUltra);
    
    // ===== SE√á√ÉO 4: VARI√ÅVEIS DE CONTROLE =====
    let poteChacoalhado = false;
    let seedRandom = Date.now();
    let sorteioJaRealizado = false;
    
    console.log('üé≤ Vari√°veis inicializadas:');
    console.log('  - poteChacoalhado:', poteChacoalhado);
    console.log('  - seedRandom:', seedRandom);
    console.log('  - sorteioJaRealizado:', sorteioJaRealizado);
    
    // Inicializa√ß√£o autom√°tica com a data pr√©-selecionada
    setTimeout(() => {
        if (semanaInicio.value) {
            statusTexto.textContent = 'Data pr√©-selecionada. Verificando...';
            verificarSorteioExistente(semanaInicio.value);
        } else {
            statusTexto.textContent = 'Selecione uma data para come√ßar';
            statusSorteio.className = 'alert alert-info text-center';
        }
    }, 500);
    
    // Verifica sorteio existente quando data muda
    semanaInicio.addEventListener('change', function() {
        if (this.value) {
            verificarSorteioExistente(this.value);
        } else {
            resetarInterface();
        }
    });
    
    // Fun√ß√£o para verificar se j√° existe sorteio
    function verificarSorteioExistente(data) {
        statusTexto.textContent = 'Verificando sorteio existente...';
        statusSorteio.className = 'alert alert-info text-center';
        
        fetch('/admin/sortear/verificar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ semana_inicio: data })
        })
        .then(response => response.json())
        .then(result => {
            if (result.existe) {
                // Sorteio j√° existe - mostra resultado e desabilita bot√µes
                mostrarSorteioExistente(result.data);
                sorteioJaRealizado = true;
            } else {
                // Liberado para novo sorteio
                liberarParaNovoSorteio();
            }
        })
        .catch(error => {
            console.error('Erro ao verificar sorteio:', error);
            statusTexto.textContent = 'Erro ao verificar sorteio. Tente novamente.';
            statusSorteio.className = 'alert alert-danger text-center';
        });
    }
    
    // Libera interface para novo sorteio
    function liberarParaNovoSorteio() {
        sorteioJaRealizado = false;
        potesContainer.style.display = 'block';
        resultadoExistente.style.display = 'none';
        
        // Verifica se h√° lojas suficientes
        if (lojasBig.length === 0 || lojasUltra.length === 0) {
            statusTexto.textContent = '‚ö†Ô∏è N√£o h√° lojas suficientes para sortear!';
            statusSorteio.className = 'alert alert-warning text-center';
            btnChacoalhar.disabled = true;
            btnSortearFinal.disabled = true;
        } else {
            btnChacoalhar.disabled = false;
            statusTexto.textContent = 'Pronto! Chacoalhe os potes para come√ßar';
            statusSorteio.className = 'alert alert-success text-center';
        }
    }
    
    // Mostra sorteio j√° existente
    function mostrarSorteioExistente(dados) {
        potesContainer.style.display = 'none';
        resultadoExistente.style.display = 'block';
        
        resultadoExistente.innerHTML = `
            <div class="resultado-existente">
                <h4>‚úÖ Sorteio J√° Realizado</h4>
                <div class="row">
                    <div class="col-md-6">
                        <h5>üè¢ Loja BIG</h5>
                        <div class="ganhador-nome ganhador-big">
                            ${dados.loja_big.nome}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>üè¨ Loja ULTRA</h5>
                        <div class="ganhador-nome ganhador-ultra">
                            ${dados.loja_ultra.nome}
                        </div>
                    </div>
                </div>
                <p class="mt-3">
                    <small>Sorteio realizado em: ${dados.data_sorteio}</small>
                </p>
            </div>
        `;
        
        statusTexto.innerHTML = `<strong>‚ö†Ô∏è Sorteio j√° realizado para esta semana!</strong><br/>
            BIG: <strong>${dados.loja_big.nome}</strong> | ULTRA: <strong>${dados.loja_ultra.nome}</strong>`;
        statusSorteio.className = 'alert alert-warning text-center';
        
        // Desabilita todos os bot√µes
        btnChacoalhar.disabled = true;
        btnSortearFinal.disabled = true;
        btnChacoalhar.textContent = '‚ùå J√Å SORTEADO';
        btnSortearFinal.textContent = '‚ùå J√Å REALIZADO';
    }
    
    // Fun√ß√£o chacoalhar
    btnChacoalhar.addEventListener('click', function() {
        console.log('üé≤ Bot√£o chacoalhar clicado!');
        
        if (sorteioJaRealizado) {
            alert('‚ö†Ô∏è Sorteio j√° foi realizado para esta semana!');
            return;
        }
        
        if (lojasBig.length === 0 || lojasUltra.length === 0) {
            alert('‚ö†Ô∏è N√£o h√° lojas suficientes para sortear!');
            return;
        }
        
        // Atualiza seed com hor√°rio atual
        seedRandom = Date.now();
        
        // Efeito visual de tremor
        potesContainer.classList.add('tremor');
        btnChacoalhar.disabled = true;
        btnChacoalhar.innerHTML = 'üå™Ô∏è CHACOALHANDO...';
        
        statusTexto.textContent = 'Chacoalhando os potes...';
        statusSorteio.className = 'alert alert-info text-center';
        
        // Embaralha as lojas visualmente
        embaralharLojas();
        
        setTimeout(() => {
            potesContainer.classList.remove('tremor');
            btnChacoalhar.disabled = false;
            btnChacoalhar.innerHTML = '‚úÖ POTES CHACOALHADOS';
            btnChacoalhar.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
            
            // Habilita bot√£o de sorteio
            btnSortearFinal.disabled = false;
            poteChacoalhado = true;
            
            statusTexto.textContent = 'Potes chacoalhados! Clique em "Realizar Sorteio"';
            statusSorteio.className = 'alert alert-primary text-center';
        }, 2000);
    });
    
    // Fun√ß√£o para embaralhar lojas visualmente
    function embaralharLojas() {
        const intervalos = [];
        
        // Embaralha BIG
        const containerBig = document.getElementById('lojasBigDisponiveis');
        if (containerBig) {
            intervalos.push(setInterval(() => {
                embaralharElementos(containerBig);
            }, 100));
        }
        
        // Embaralha ULTRA  
        const containerUltra = document.getElementById('lojasUltraDisponiveis');
        if (containerUltra) {
            intervalos.push(setInterval(() => {
                embaralharElementos(containerUltra);
            }, 100));
        }
        
        // Para o embaralhamento ap√≥s 1.5s
        setTimeout(() => {
            intervalos.forEach(interval => clearInterval(interval));
        }, 1500);
    }
    
    // Embaralha elementos DOM
    function embaralharElementos(container) {
        const elementos = Array.from(container.children);
        elementos.forEach(el => el.classList.add('embaralhar'));
        
        // Reordena elementos
        for (let i = elementos.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            container.appendChild(elementos[j]);
        }
        
        setTimeout(() => {
            elementos.forEach(el => el.classList.remove('embaralhar'));
        }, 300);
    }
    
    // ===== SE√á√ÉO 8: EVENT LISTENER BOT√ÉO SORTEAR - CORRIGIDO! =====
    console.log('üéØ Configurando event listener do bot√£o Realizar Sorteio...');
    
    // Remove listeners anteriores (caso existam)
    btnSortearFinal.removeEventListener('click', handleSortearClick);
    
    // Fun√ß√£o separada para o click handler
    function handleSortearClick(event) {
        console.log('üéØ === BOT√ÉO REALIZAR SORTEIO CLICADO ===');
        console.log('  - Event:', event);
        console.log('  - Target:', event.target);
        console.log('  - Bot√£o disabled:', btnSortearFinal.disabled);
        
        // Previne comportamento padr√£o
        event.preventDefault();
        event.stopPropagation();
        
        // ===== VALIDA√á√ïES CR√çTICAS =====
        console.log('üîç Executando valida√ß√µes:');
        
        // 1. Verifica se sorteio j√° foi realizado
        if (sorteioJaRealizado) {
            console.warn('‚ö†Ô∏è Valida√ß√£o falhou: Sorteio j√° realizado');
            alert('‚ö†Ô∏è Sorteio j√° foi realizado para esta semana!');
            return;
        }
        console.log('  ‚úÖ Sorteio n√£o foi realizado ainda');
        
        // 2. Verifica se pote foi chacoalhado
        if (!poteChacoalhado) {
            console.warn('‚ö†Ô∏è Valida√ß√£o falhou: Potes n√£o chacoalhados');
            alert('‚ö†Ô∏è Voc√™ precisa chacoalhar os potes primeiro!');
            return;
        }
        console.log('  ‚úÖ Potes foram chacoalhados');
        
        // 3. Verifica se o objeto sorteioAnimado existe
        if (!window.sorteioAnimado) {
            console.error('‚ùå Valida√ß√£o falhou: SorteioAnimado n√£o encontrado!');
            alert('‚ùå Erro: Sistema de sorteio n√£o carregado. Recarregue a p√°gina.');
            return;
        }
        console.log('  ‚úÖ SorteioAnimado dispon√≠vel');
        
        // 4. Verifica se h√° lojas suficientes
        if (lojasBig.length === 0 || lojasUltra.length === 0) {
            console.error('‚ùå Valida√ß√£o falhou: Lojas insuficientes');
            alert('‚ùå Erro: N√£o h√° lojas suficientes para sortear!');
            return;
        }
        console.log('  ‚úÖ Lojas suficientes dispon√≠veis');
        
        // ===== IN√çCIO DO SORTEIO =====
        console.log('üöÄ Todas as valida√ß√µes passaram! Iniciando sorteio...');
        
        // Usa a seed gerada no chacoalhar para determinismo
        if (typeof Math.seedrandom === 'function') {
            console.log('üé≤ Aplicando seed determin√≠stica:', seedRandom);
            Math.seedrandom(seedRandom);
        } else {
            console.warn('‚ö†Ô∏è Math.seedrandom n√£o dispon√≠vel, usando random padr√£o');
        }
        
        // Atualiza interface
        statusTexto.textContent = 'Iniciando sorteio cinematogr√°fico...';
        statusSorteio.className = 'alert alert-warning text-center';
        
        // Desabilita bot√£o temporariamente
        btnSortearFinal.disabled = true;
        btnSortearFinal.textContent = 'üé¨ SORTEANDO...';
        
        console.log('üé¨ Dados do sorteio:');
        console.log('  - Lojas BIG:', lojasBig.length, 'dispon√≠veis');
        console.log('  - Lojas ULTRA:', lojasUltra.length, 'dispon√≠veis');
        console.log('  - Seed:', seedRandom);
        console.log('  - Timestamp:', new Date().toISOString());
        
        // ===== CHAMADA DO SORTEIO =====
        try {
            console.log('üéØ Chamando window.sorteioAnimado.iniciarSorteioLojas...');
            window.sorteioAnimado.iniciarSorteioLojas(lojasBig, lojasUltra);
            console.log('‚úÖ Sorteio iniciado com sucesso!');
        } catch (error) {
            console.error('‚ùå ERRO CR√çTICO ao iniciar sorteio:', error);
            console.error('  - Message:', error.message);
            console.error('  - Stack:', error.stack);
            alert('‚ùå Erro cr√≠tico ao iniciar sorteio: ' + error.message);
            
            // Restaura bot√£o em caso de erro
            btnSortearFinal.disabled = false;
            btnSortearFinal.textContent = 'üéØ Realizar Sorteio';
        }
    }
    
    // Anexa o event listener
    btnSortearFinal.addEventListener('click', handleSortearClick);
    console.log('‚úÖ Event listener anexado ao bot√£o Realizar Sorteio!');
    
    // Teste adicional: verifica se o bot√£o responde a clique
    btnSortearFinal.addEventListener('mousedown', function() {
        console.log('üñ±Ô∏è Mousedown detectado no bot√£o Realizar Sorteio');
    });
    
    btnSortearFinal.addEventListener('mouseup', function() {
        console.log('üñ±Ô∏è Mouseup detectado no bot√£o Realizar Sorteio');
    });
    
    // ===== SE√á√ÉO 8.5: BOT√ÉO DE TESTE DE EMERG√äNCIA =====
    if (btnTesteEmergencia) {
        console.log('üÜò Configurando bot√£o de teste de emerg√™ncia...');
        
        btnTesteEmergencia.addEventListener('click', function(event) {
            console.log('üÜò === TESTE DE EMERG√äNCIA ATIVADO ===');
            event.preventDefault();
            event.stopPropagation();
            
            // For√ßa os par√¢metros para teste
            poteChacoalhado = true;
            sorteioJaRealizado = false;
            
            console.log('üîß Par√¢metros for√ßados para teste:');
            console.log('  - poteChacoalhado:', poteChacoalhado);
            console.log('  - sorteioJaRealizado:', sorteioJaRealizado);
            
            // Chama a mesma fun√ß√£o do bot√£o principal
            handleSortearClick(event);
        });
        
        // Mostra o bot√£o de emerg√™ncia ap√≥s 10 segundos se o principal n√£o funcionar
        setTimeout(() => {
            if (btnSortearFinal.disabled && !sorteioJaRealizado) {
                console.log('‚ö†Ô∏è Ativando bot√£o de emerg√™ncia - bot√£o principal n√£o respondeu');
                btnTesteEmergencia.style.display = 'block';
                btnTesteEmergencia.title = 'Use apenas se o bot√£o principal n√£o funcionar';
            }
        }, 10000);
    }
    
    // Resetar interface
    function resetarInterface() {
        poteChacoalhado = false;
        sorteioJaRealizado = false;
        btnChacoalhar.innerHTML = 'üé≤ Chacoalhar Potes';
        btnChacoalhar.style.background = 'linear-gradient(45deg, #ff6b6b, #ee5a24)';
        btnChacoalhar.disabled = true;
        btnSortearFinal.disabled = true;
        btnSortearFinal.textContent = 'üéØ Realizar Sorteio';
        potesContainer.style.display = 'block';
        resultadoExistente.style.display = 'none';
        statusTexto.textContent = 'Selecione uma data para come√ßar';
        statusSorteio.className = 'alert alert-info text-center';
    }
    
    // Sobrescreve fun√ß√£o AJAX do sorteio
    window.sorteioAnimado.submitarFormularioAjax = function(resultados) {
        console.log('üíæ Salvando resultados:', resultados);
        
        const lojaBig = resultados.find(r => r.tipo === 'Loja BIG');
        const lojaUltra = resultados.find(r => r.tipo === 'Loja ULTRA');
        
        if (!lojaBig || !lojaUltra) {
            window.sorteioAnimado.exibirErro('Erro nos resultados do sorteio');
            return;
        }
        
        const dados = {
            semana_inicio: semanaInicio.value,
            loja_big_id: lojaBig.vencedor.id,
            loja_ultra_id: lojaUltra.vencedor.id
        };
        
        fetch('/admin/sortear/ajax', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': form.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Personaliza mensagem de sucesso
                const mensagemParabens = `
                    üéâ PARAB√âNS AOS GANHADORES! üéâ<br/>
                    <strong>${lojaBig.vencedor.nome}</strong> (BIG) e <strong>${lojaUltra.vencedor.nome}</strong> (ULTRA)<br/>
                    Voc√™s foram sorteados para a semana de ${data.data.semana}!
                `;
                window.sorteioAnimado.exibirSucesso(mensagemParabens);
            } else {
                window.sorteioAnimado.exibirErro(data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro AJAX:', error);
            window.sorteioAnimado.exibirErro('Erro de comunica√ß√£o com o servidor');
        });
    };
    
    // ===== SE√á√ÉO 9: FINALIZA√á√ÉO E TESTE =====
    console.log('üèÅ === FINALIZA√á√ÉO DA INICIALIZA√á√ÉO ===');
    console.log('‚úÖ Todos os componentes inicializados com sucesso!');
    console.log('üìä Resumo do sistema:');
    console.log('  - Elementos DOM: OK');
    console.log('  - SorteioAnimado: OK');
    console.log('  - Event Listeners: OK');
    console.log('  - Dados das lojas: OK');
    console.log('  - Fun√ß√µes AJAX: OK');
    console.log('');
    console.log('üéØ Sistema pronto para uso!');
    console.log('‚ö° Para testar manualmente, digite: testSorteio()');
    
    // Fun√ß√£o de teste global
    window.testSorteio = function() {
        console.log('üß™ === TESTE MANUAL DO SISTEMA ===');
        console.log('1. Testando elementos DOM...');
        console.log('  - btnSortearFinal existe:', !!btnSortearFinal);
        console.log('  - btnSortearFinal disabled:', btnSortearFinal.disabled);
        console.log('  - btnSortearFinal texto:', btnSortearFinal.textContent);
        
        console.log('2. Testando vari√°veis...');
        console.log('  - poteChacoalhado:', poteChacoalhado);
        console.log('  - sorteioJaRealizado:', sorteioJaRealizado);
        
        console.log('3. Testando SorteioAnimado...');
        console.log('  - window.sorteioAnimado:', !!window.sorteioAnimado);
        console.log('  - M√©todos dispon√≠veis:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.sorteioAnimado)));
        
        console.log('4. Testando dados...');
        console.log('  - Lojas BIG:', lojasBig.length);
        console.log('  - Lojas ULTRA:', lojasUltra.length);
        
        if (btnSortearFinal.disabled) {
            console.log('‚ö†Ô∏è Bot√£o est√° desabilitado. Poss√≠veis causas:');
            console.log('  - Potes n√£o foram chacoalhados ainda');
            console.log('  - Sorteio j√° foi realizado');
            console.log('  - Erro na inicializa√ß√£o');
        } else {
            console.log('‚úÖ Bot√£o est√° habilitado e pronto para uso!');
        }
        
        console.log('üß™ Teste conclu√≠do!');
    };
    
    // Atualiza status final
    if (statusTexto && statusSorteio) {
        // Verifica se deve fazer inicializa√ß√£o autom√°tica
        if (semanaInicio.value && semanaInicio.value.trim() !== '') {
            console.log('üìÖ Data pr√©-selecionada encontrada:', semanaInicio.value);
            statusTexto.textContent = 'Data pr√©-selecionada. Verificando...';
            verificarSorteioExistente(semanaInicio.value);
        } else {
            console.log('üìÖ Nenhuma data pr√©-selecionada');
            statusTexto.textContent = 'Sistema carregado! Selecione uma data para come√ßar.';
            statusSorteio.className = 'alert alert-info text-center';
        }
    }
    
    console.log('‚úÖ INICIALIZA√á√ÉO COMPLETA!');
}

// Adiciona biblioteca para seed random
!function(a,b){function c(c,d,e){var f=[];d=1==d?{entropy:!0}:d||{};var g=h(i(d.entropy?[c,j(a)]:null==c?k():c,3),f),l=new m(f),n=function(){for(var a=l.g(o),b=p,c=0;q>a;)a=(a+c)*r,b*=r,c=l.g(1);for(;a>=s;)a/=2,b/=2,c>>>=1;return(a+c)/b};return n.int32=function(){return 0|l.g(4)},n.quick=function(){return l.g(4)/4294967296},n.double=n,h(j(l.S),a),(d.pass||e||function(a,c,d,e){return e&&(e.S&&n(e,l),a.state=function(){return n(l,{})}),d?(b[t]=a,c):a})(n,g,"global"in d?d.global:this==b,d.state)}function d(a){return typeof a==="string"?a:String(a)}function e(a,b){return typeof a==="number"?a:parseInt(b,10)}function f(a,b){return a>b?a:b}function g(a,b){return a<b?a:b}function h(a,b){var c,d=a.length,e=0,f=0;for(c=0;d>c;c++)e=19*e+a.charCodeAt(c),f=e&((1<<6)-1);return(b[f]=(b[f]||0)+1,String.fromCharCode(f))}function i(a,b){var c=a+"",d,e=0;for(b=0;b<c.length;)d=.02519603282416938*c.charCodeAt(b++),d-=~~d,e+=d*d*d*7*5e6;return e}function j(a){for(var b,c=a.length,d=this,e=0,f=d.i=d.j=0,g=d.S=[];c>e;)g[e]=e++;for(e=0;c>e;e++)g[e]=g[f=w&f+g[e]+g[(d.i=w&d.i+1)]],g[f]=g[d.i];(d.i=d.j=0)}function k(){try{var b;return u&&(b=u.randomBytes)?b=b(r):(b=new Uint8Array(r),(v.crypto||v.msCrypto).getRandomValues(b)),j(b)}catch(c){var d=v.navigator,e=d&&d.plugins;return j([+new Date,v,e,v.screen,j(a)])}}function l(a){try{return u.createHash("sha256").update(a).digest()}catch(b){return[a]}}function m(a){j(this,a)}function n(a,b){return b.i=a.i,b.j=a.j,b.S=a.S.slice(),b}var o=6,p=52,q=1,r=4,s=Math.pow(2,53),t="random",u=c.crypto,v=c;if("object"==typeof module&&module.exports){module.exports=c;try{u=require("crypto")}catch(w){}}else"function"==typeof define&&define.amd?define(function(){return c}):v["seed"+t]=c;var x=Math.pow(r,o),y=Math.pow(2,p),z=2*y,A=r-1,w=4294967295;if(l(b[t])!=b[t]&&l(Math.random())!=Math.random()){b[t]=c}Math.seedrandom=c}([],"",Math);
</script>
{% endblock %} 